name: ZIP safety check

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  enforce-zip-location:
    runs-on: ubuntu-latest
    steps:
      - name: Inspect ZIP locations
        id: inspect
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.info("No pull request context; exiting");
              return;
            }

            const files = await github.paginate(
              github.rest.pulls.listFiles,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                per_page: 100,
              }
            );

            const zipFiles = files.filter((f) => f.filename.toLowerCase().endsWith('.zip'));
            const violations = zipFiles.filter((f) => !f.filename.startsWith('INBOX_UPLOADS/'));

            core.setOutput('zip_count', String(zipFiles.length));
            core.setOutput('violation_count', String(violations.length));
            core.setOutput('violations', JSON.stringify(violations.map((f) => f.filename)));

      - name: Comment on violations
        if: steps.inspect.outputs.violation_count != '0'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { repo, owner } = context.repo;
            const prNumber = context.payload.pull_request.number;
            const violations = JSON.parse(process.env.VIOLATIONS || '[]');
            const header = '⚠️ ZIP safety check';

            const body = [
              header,
              '',
              'ZIP files were detected **outside** `INBOX_UPLOADS/`:',
              ...violations.map((f) => `- ${f}`),
              '',
              'Move ZIPs into `INBOX_UPLOADS/` and push an update so automation can process them safely.',
            ].join('\n');

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number: prNumber,
              per_page: 100,
            });

            const existing = comments.find(
              (c) => c.user?.login === 'github-actions[bot]' && c.body?.includes(header)
            );

            if (existing) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: existing.id, body });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number: prNumber, body });
            }
        env:
          VIOLATIONS: ${{ steps.inspect.outputs.violations }}

      - name: Log result
        run: |
          if [ "${{ steps.inspect.outputs.violation_count }}" = "0" ]; then
            echo "ZIP safety check passed: no ZIPs outside INBOX_UPLOADS/.";
          else
            echo "ZIP safety check completed with warnings.";
          fi
